<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mis Apuestas</title>
  <link rel="stylesheet" href="styles/historial.css" />

</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="lobby.html"><img src="imagenes/logo.png" alt="Logo de apuestas"/></a>
      <h1>Mis Apuestas, <span id="nombre-usuario"></span></h1>
    </div>
    <div class="header-right">
      <!-- <button class="header-button" onclick="window.location.href='perfil.html'" >Perfil</button> -->
      <button id="cerrar-sesion" class="header-button">Cerrar sesión</button>
    </div>
  </header>

  <main id="contenedor-jornadas">
    <!-- Aquí se rellenarán las jornadas -->
    <div id="loading-container" class="login-container">
      <img src="imagenes/loading.gif" alt="Cargando..." style="width: 100px; height: auto;" />
      <p style="text-align:center;">Cargando datos...</p>
    </div>
  </main>

<script>
  function formatearFecha(fechaIso) {
    if (!fechaIso) return '';
    const fecha = new Date(fechaIso);
    if (isNaN(fecha.getTime())) return String(fechaIso);
    return fecha.toISOString().split('T')[0];
  }

  function formatearHora(horaIso) {
    if (!horaIso) return '';
    const fecha = new Date(horaIso);
    if (isNaN(fecha.getTime())) return String(horaIso);
    return fecha.toTimeString().split(' ')[0];
  }

  const formatNum = (v, dec=2) => (typeof v === 'number' && isFinite(v)) ? v.toFixed(dec) : '0.00';

  document.addEventListener("DOMContentLoaded", () => {
    const jugador = localStorage.getItem("usuario");
    if (!jugador) {
      alert("No has iniciado sesión.");
      window.location.href = "login.html";
      return;
    }

    const url = `https://script.google.com/macros/s/AKfycbxSu-JSjNKIt1KyOV4W04TOeR2HQiWw49vVoVVu8O3c8o4AnIi2ETCFaFffFyfJehZcqg/exec?jugador=${encodeURIComponent(jugador)}`;

    fetch(url)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(rawData => {
        console.log('Respuesta del GAS:', rawData);

        // Normalizamos data a: [{jornada, resumen:{...}, partidos:[...]}, ...]
        let data = [];

        if (Array.isArray(rawData) && rawData.length && rawData[0] && 'partidos' in rawData[0] && 'resumen' in rawData[0]) {
          // NUEVO formato (agrupado por GAS)
          data = rawData;
        } else if (Array.isArray(rawData)) {
          // Formato ANTIGUO (filas sueltas). Agrupamos aquí.
          const byJornada = {};
          rawData.forEach(item => {
            const j = String(item.jornada ?? 'Sin jornada').trim();
            if (!byJornada[j]) {
              byJornada[j] = {
                jornada: j,
                resumen: {
                  acierto_puntos: item.acierto_puntos ?? null,
                  // convierte coma decimal si viene como string "7,53"
                  cuota_puntos: item.cuota_puntos != null ? parseFloat(String(item.cuota_puntos).replace(',', '.')) : null,
                  resultado_puntos: item.resultado_puntos != null ? parseFloat(String(item.resultado_puntos).replace(',', '.')) : null
                },
                partidos: []
              };
            }
            // push partido (usa las columnas tal cual vengan del histórico)
            byJornada[j].partidos.push(item);
          });
          data = Object.values(byJornada);
        } else {
          throw new Error('Formato de respuesta no esperado');
        }

        const contenedor = document.getElementById("contenedor-jornadas");
        contenedor.innerHTML = "";

        if (!data.length) {
          contenedor.innerHTML = `<p style="text-align:center">No hay datos para <strong>${jugador}</strong>.</p>`;
          return;
        }

        data.forEach(jornadaData => {
          const divJornada = document.createElement("div");
          divJornada.classList.add("jornada-box");

          const cabecera = document.createElement("button");
          cabecera.textContent = `Jornada ${jornadaData.jornada}`;
          cabecera.classList.add("jornada-header");

          const r = jornadaData.resumen || {};
          const resumen = document.createElement("div");
          resumen.classList.add("jornada-resumen");
          resumen.innerHTML = `
            <div><strong>Partidos acertados:</strong> ${r.acierto_puntos ?? 0}</div>
            <div><strong>Sumatorio de cuotas:</strong> ${formatNum(r.cuota_puntos)}</div>
            <div><strong>Puntos obtenidos:</strong> ${formatNum(r.resultado_puntos)}</div>
          `;

          const tabla = document.createElement("table");
          tabla.classList.add("tabla-jornada");
          tabla.innerHTML = `
            <thead>
              <tr>
                <th>Local</th>
                <th>Visitante</th>
                <th>Pronóstico</th>
                <th>Cuota</th>
                <th>Acierto</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          const tbody = tabla.querySelector("tbody");

          (jornadaData.partidos || []).forEach(apuesta => {
            const fila = document.createElement("tr");
            const acierto =
              apuesta.acierto === true ? '✅' :
              apuesta.acierto === false ? '❌' : (apuesta.acierto || '');

            fila.innerHTML = `
              <td>${apuesta.equipo_Local ?? ''}</td>
              <td>${apuesta.equipo_Visitante ?? ''}</td>
              <td>${apuesta.pronostico ?? ''}</td>
              <td>${apuesta.cuota ?? ''}</td>
              <td>${acierto}</td>
            `;
            tbody.appendChild(fila);
          });

          resumen.style.display = "none";
          tabla.style.display = "none";

          cabecera.addEventListener("click", () => {
            const visible = tabla.style.display === "none";
            tabla.style.display = visible ? "table" : "none";
            resumen.style.display = visible ? "block" : "none";
          });

          divJornada.appendChild(cabecera);
          divJornada.appendChild(resumen);
          divJornada.appendChild(tabla);
          contenedor.appendChild(divJornada);
        });
      })
      .catch(err => {
        console.error("Error al obtener apuestas:", err);
        alert("No se pudieron cargar los datos. Revisa la consola.");
      });
  });
</script>

<script src="script.js"></script>
</body>
</html>
