<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mis Apuestas</title>
  <link rel="stylesheet" href="styles/historial.css" />

</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="lobby.html"><img src="imagenes/logo.png" alt="Logo de apuestas"/></a>
      <h1>Mis Apuestas</h1>
    </div>
    <div class="header-right">
      <button class="header-button" onclick="window.location.href='perfil.html'" >Perfil</button>
      <button id="cerrar-sesion" class="header-button">Cerrar sesión</button>
    </div>
  </header>

  <main id="contenedor-jornadas">
    <!-- Aquí se rellenarán las jornadas -->
    <div id="loading-container" class="login-container">
      <img src="imagenes/loading.gif" alt="Cargando..." style="width: 100px; height: auto;" />
      <p style="text-align:center;">Cargando datos...</p>
    </div>
  </main>

<script>
  function formatearFecha(fechaIso) {
    const fecha = new Date(fechaIso);
    return fecha.toISOString().split('T')[0];
  }

  function formatearHora(horaIso) {
    const fecha = new Date(horaIso);
    return fecha.toTimeString().split(' ')[0];
  }

  document.addEventListener("DOMContentLoaded", () => {
    const jugador = localStorage.getItem("usuario"); 
    if (!jugador) {
      alert("No has iniciado sesión.");
      window.location.href = "login.html";
      return;
    }

    const url = `https://script.google.com/macros/s/AKfycbxJWdlz2Wz_jCZ4C1vkpAYVawrWXk8g0auaU4EMF9HNxiFkmqD-MPGJF8-zrgz0QuNLvQ/exec?jugador=${encodeURIComponent(jugador)}`;

    fetch(url)
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data)) {
          console.error("Error en respuesta:", data);
          return;
        }

        // Agrupar por jornada
        const jornadas = {};
        data.forEach(apuesta => {
          const j = apuesta.jornada || "Sin jornada";
          if (!jornadas[j]) jornadas[j] = [];
          jornadas[j].push(apuesta);
        });

        const contenedor = document.getElementById("contenedor-jornadas");
        contenedor.innerHTML = "";

        Object.keys(jornadas).forEach(jornada => {
          const divJornada = document.createElement("div");
          divJornada.classList.add("jornada-box");

          // Cabecera de la jornada
          const cabecera = document.createElement("button");
          cabecera.textContent = `Jornada ${jornada}`;
          cabecera.classList.add("jornada-header");

          // --- Caja resumen ---
          const datosResumen = jornadas[jornada][0]; // tomo el primero, todos tienen mismos datos
          const resumen = document.createElement("div");
          resumen.classList.add("jornada-resumen");
          resumen.innerHTML = `
            <div><strong>Partidos acertados:</strong> ${datosResumen.acierto_puntos || 0}</div>
            <div><strong>Sumatorio de cuotas:</strong> ${datosResumen.cuota_puntos ? parseFloat(datosResumen.cuota_puntos).toFixed(2) : '0.00'}</div>
            <div><strong>Puntos obtenidos:</strong> ${datosResumen.resultado_puntos ? parseFloat(datosResumen.resultado_puntos).toFixed(2) : '0.00'}</div>
          `;
          // --- Tabla de apuestas ---
          const tabla = document.createElement("table");
          tabla.classList.add("tabla-jornada");
          tabla.innerHTML = `
            <thead>
              <tr>
                <th>Equipo Local</th>
                <th>Equipo Visitante</th>
                <th>Pronóstico</th>
                <th>Acierto</th>
                <th>Día</th>
                <th>Hora</th>
                <th>Cuota</th>
                <th>Resultado</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          const tbody = tabla.querySelector("tbody");

          jornadas[jornada].forEach(apuesta => {
            const fila = document.createElement("tr");
            fila.innerHTML = `
              <td>${apuesta.equipo_Local || ''}</td>
              <td>${apuesta.equipo_Visitante || ''}</td>
              <td>${apuesta.pronostico || ''}</td>
              <td>${apuesta.acierto === true ? '✅' : apuesta.acierto === false ? '❌' : ''}</td>
              <td>${formatearFecha(apuesta.dia)}</td>
              <td>${formatearHora(apuesta.hora)}</td>
              <td>${apuesta.cuota || ''}</td>
              <td>${apuesta.resultado || ''}</td>
            `;
            tbody.appendChild(fila);
          });

          // Ocultar al inicio
          resumen.style.display = "none";
          tabla.style.display = "none";

          // Toggle
          cabecera.addEventListener("click", () => {
            const visible = tabla.style.display === "none";
            tabla.style.display = visible ? "table" : "none";
            resumen.style.display = visible ? "block" : "none";
          });

          divJornada.appendChild(cabecera);
          divJornada.appendChild(resumen);
          divJornada.appendChild(tabla);
          contenedor.appendChild(divJornada);
        });
      })
      .catch(err => {
        console.error("Error al obtener apuestas:", err);
      });
  });
</script>
<script src="script.js"></script>
</body>
</html>
